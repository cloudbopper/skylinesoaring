{% extends "base.html" %}
{% block content %}
<h1>Manage Logsheet</h1>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Logsheet for {{ logsheet.log_date }}</h5>
    <p class="card-text">Location: {{ logsheet.location }}</p>
    <p class="card-text"><small class="text-muted">Created by {{ logsheet.created_by }} on {{ logsheet.created_at }}</small></p>
    {% if logsheet.revisions.exists %}
    <details>Revision History</details>
      <ul class="mb-0">
        {% for rev in logsheet.revisions.all %}
        <li> Reopened by {{ rev.revised_by }} on {{ rev.revised_at|date:"Y-m-d H:i" }}</li>
        {% endfor %}
      </ul>
    </details>
    {% endif %}
  </div>
</div>
{% if logsheet.finalized and user.is_superuser %}
  <form method="post" class="mt-2">
    {% csrf_token %}
    <button type="submit" name="revise" class="btn btn-outline-danger">
      Revise Logsheet
    </button>
  </form>
{% endif %}

{% if not logsheet.finalized %}
  <form method="post" class="mt-3">
    {% csrf_token %}
    <button type="submit" name="finalize" class="btn btn-danger">
      Finalize Logsheet
    </button>
  </form>
{% else %}
  <div class="alert alert-warning mt-3">
    <strong>This logsheet is finalized.</strong> No further changes are allowed.
  </div>
{% endif %}

<hr>
<h2>Flights</h2>

{% if logsheet.flights.exists %}
  <ul class="list-group">
    {% for flight in flights %}
    <li class="list-group-item">
      {{ flight.launch_time }} â€” {{ flight.landing_time }}:
      {{ flight.pilot }} in {{ flight.glider }} towed by {{ flight.towplane }}
      <a href="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}" class="btn btn-sm btn-outline-secondary">
        Edit
      </a>

    </li>
  {% empty %}
    <li class="list-group-item">No flights found.</li>
  {% endfor %}
  </ul>
{% else %}
  <p>No flights recorded yet for this logsheet.</p>
{% endif %}
<form method="get" class="row mb-3">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control" placeholder="Search by pilot or instructor" value="{{ query }}">
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-primary">Filter</button>
  </div>
</form>


<hr>

{% if not logsheet.finalized %}
<h3>Add a New Flight</h3>

<form method="post">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="row">
    <div class="col-md-3">{{ form.launch_time.label }}{{ form.launch_time }}</div>
    <div class="col-md-3">{{ form.landing_time.label }}{{ form.landing_time }}</div>
    <div class="col-md-3">{{ form.pilot.label }}{{ form.pilot }}</div>
    <div class="col-md-3">{{ form.instructor.label }}{{ form.instructor }}</div>
  </div>

  <div class="row mt-2">
    <div class="col-md-3">{{ form.glider.label }}{{ form.glider }}</div>
    <div class="col-md-3">{{ form.tow_plane.label }}{{ form.tow_plane }}</div>
    <div class="col-md-3">{{ form.towplane.label }}{{ form.towplane }}</div>
    <div class="col-md-3">{{ form.tow_pilot.label }}{{ form.tow_pilot }}</div>
    <div class="col-md-3">{{ form.flight_type.label }}{{ form.flight_type }}</div>
    <div class="col-md-3">{{ form.field.label }}{{ form.field }}</div>
  </div>

  <div class="mt-2">{{ form.notes.label }}{{ form.notes }}</div>

  <button type="submit" class="btn btn-primary mt-3">Add Flight</button>
</form>

{% endif %}

<footer style="font-size: 0.8em; color: gray;">
  Template: <code>logsheet/logsheet_manage.html</code>
</footer>
{% endblock %}
