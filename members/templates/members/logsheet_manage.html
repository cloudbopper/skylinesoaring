{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load member_extras %}
{% block content %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const takeoff = document.getElementById("id_takeoff_time");
      const landing = document.getElementById("id_landing_time");
      const flightTime = document.getElementById("id_flight_time");
    
      function calculateDuration() {
        if (!takeoff.value || !landing.value) return;
    
        const [toH, toM] = takeoff.value.split(":").map(Number);
        const [laH, laM] = landing.value.split(":").map(Number);
    
        let takeoffMinutes = toH * 60 + toM;
        let landingMinutes = laH * 60 + laM;
    
        if (landingMinutes < takeoffMinutes) {
          landingMinutes += 24 * 60;  // Crosses midnight
        }
    
        const duration = landingMinutes - takeoffMinutes;
        const durH = Math.floor(duration / 60).toString().padStart(2, "0");
        const durM = (duration % 60).toString().padStart(2, "0");
    
        flightTime.value = `${durH}:${durM}`;
      }
    
      if (takeoff && landing && flightTime) {
        flightTime.readOnly = true;
        takeoff.addEventListener("change", calculateDuration);
        landing.addEventListener("change", calculateDuration);
      }
    });
    </script>



<div class="container mt-4">
  <h2 class="mb-3">Log Flight</h2>

  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    {{ form|crispy }}
    <button type="submit" class="btn btn-primary">Save Flight</button>
  </form>

  <hr>

  <h3 class="mb-3">Flights for {{ today }}</h3>
  {% if flight_logs %}
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Glider</th>
          <th>Pilot</th>
          <th>Passenger</th>
          <th>Tow Pilot</th>
          <th>Takeoff</th>
          <th>Landing</th>
          <th>Duration</th>
          <th>Field</th>
        </tr>
      </thead>
      <tbody>
        {% for flight in flight_logs %}
        <tr>
          <td>{{ flight.glider }}</td>
          <td>{{ flight.pilot|full_display_name }}</td>
          <td>{{ flight.instructor|full_display_name }}</td>
          <td>{{ flight.passenger|default:"â€”" }}</td>
          <td>{{ flight.towpilot|full_display_name }}</td>
          <td>{{ flight.takeoff_time }}</td>
          <td>{{ flight.landing_time }}</td>
          <td>{{ flight.flight_time }}</td>
          <td>{{ flight.airfield.code }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No flights logged today yet.</p>
  {% endif %}
</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
      const takeoff = document.getElementById('id_takeoff_time');
      const landing = document.getElementById('id_landing_time');
      const duration = document.getElementById('id_flight_time');
  
      function updateDuration() {
          if (takeoff.value && landing.value) {
              const t1 = takeoff.value.split(":").map(Number);
              const t2 = landing.value.split(":").map(Number);
  
              const date1 = new Date(0, 0, 0, t1[0], t1[1]);
              const date2 = new Date(0, 0, 0, t2[0], t2[1]);
              let diff = (date2 - date1) / 60000; // in minutes
  
              if (diff < 0) diff += 24 * 60;
  
              const hours = Math.floor(diff / 60).toString().padStart(2, '0');
              const mins = Math.floor(diff % 60).toString().padStart(2, '0');
              duration.value = `${hours}:${mins}:00`;
          } else {
              duration.value = '';  // clear if incomplete
          }
      }
  
      takeoff.addEventListener('change', updateDuration);
      landing.addEventListener('change', updateDuration);
  });
  </script>
  



{% endblock %}
